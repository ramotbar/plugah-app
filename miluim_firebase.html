<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××¢×¨×›×ª ×¤×œ×•×’×ª ××™×œ×•××™×</title>
<meta name="theme-color" content="#0a0f1e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="×¤×œ×•×’×”">
<link rel="manifest" href="manifest.json">
<script>
// Register service worker for offline support
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(function(){});
}
</script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0a0f1e;font-family:'Segoe UI',Arial,sans-serif;direction:rtl;color:white;min-height:100vh}
input,select,textarea,button{font-family:inherit}
input:focus,select:focus,textarea:focus{outline:2px solid rgba(29,78,216,0.6)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#1e293b;border-radius:3px}
.card{background:rgba(13,20,36,0.95);border-radius:12px;border:1px solid rgba(255,255,255,0.07);padding:14px;margin-bottom:10px}
.inp{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:14px;direction:rtl}
.btn{padding:10px 18px;border:none;border-radius:10px;color:white;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit}
.bblue{background:linear-gradient(135deg,#1d4ed8,#1e40af)}
.bgreen{background:linear-gradient(135deg,#059669,#047857)}
.bpurple{background:linear-gradient(135deg,#7c3aed,#6d28d9)}
.borange{background:linear-gradient(135deg,#ff6b35,#ea580c)}
.bsm{padding:4px 10px;font-size:12px;border-radius:7px;border:none;cursor:pointer;color:white;font-family:inherit}
.topbar{background:rgba(8,13,26,0.98);border-bottom:1px solid rgba(255,255,255,0.06);height:54px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;position:sticky;top:0;z-index:100}
.tabs{display:flex;background:rgba(10,15,26,0.9);border-bottom:1px solid rgba(255,255,255,0.05);overflow-x:auto}
.tab-btn{padding:12px 14px;border:none;background:transparent;color:#64748b;font-size:13px;cursor:pointer;white-space:nowrap;font-family:inherit;border-bottom:2px solid transparent}
.tab-btn.on{border-bottom-color:var(--c);color:var(--c)}
.content{padding:16px}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:999;padding:12px}
.modal-box{background:#0a1020;border-radius:18px;border:1px solid rgba(255,255,255,0.1);padding:22px;width:100%;max-width:480px;max-height:85vh;overflow-y:auto}
.fld{margin-bottom:12px}
.fld label{display:block;color:#94a3b8;font-size:12px;margin-bottom:4px}
.av{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0}
.grid2{display:flex;gap:10px}
.grid2 .fld{flex:1}
</style>
</head>
<body>
<div id="root"><div style="min-height:100vh;background:#0a0f1e;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px"><div style="width:50px;height:50px;border:3px solid rgba(29,78,216,0.3);border-top-color:#1d4ed8;border-radius:50%;animation:spin 0.8s linear infinite"></div><p style="color:#64748b;font-size:14px">××ª×—×‘×¨ ×œ××¢×¨×›×ª...</p></div></div>
<style>@keyframes spin{to{transform:rotate(360deg)}}</style>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDpVZy1WW0aUwcfNfbyCCJo--QN2s-Ylfw",
  authDomain: "pluga-h-master-board.firebaseapp.com",
  projectId: "pluga-h-master-board",
  storageBucket: "pluga-h-master-board.firebasestorage.app",
  messagingSenderId: "839784828608",
  appId: "1:839784828608:web:89d19ee5190f0b9ad2a725"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// â”€â”€ Firestore helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// All app data lives in a single document: "app/state"
// Sub-collections: users, reqs, tanks, scheds, special, tsamReports, achievements

async function fbLoad(){
  try {
    // Load config (users, tsamItems, achieveTopics, shatzalTypes)
    const cfgSnap = await getDoc(doc(db,'app','config'));
    if(cfgSnap.exists()){
      const d = cfgSnap.data();
      if(d.users) S.users = d.users;
      if(d.tsamItems) S.tsamItems = d.tsamItems;
      if(d.achieveTopics) S.achieveTopics = d.achieveTopics;
      if(d.shatzalTypes) S.shatzalTypes = d.shatzalTypes;
    }
    // Load dynamic data
    const dataSnap = await getDoc(doc(db,'app','data'));
    if(dataSnap.exists()){
      const d = dataSnap.data();
      if(d.reqs) S.reqs = d.reqs;
      if(d.daily) S.daily = d.daily;
      if(d.tanks) S.tanks = d.tanks;
      if(d.scheds) S.scheds = d.scheds;
      if(d.special) S.special = d.special;
      if(d.tsamReports) S.tsamReports = d.tsamReports;
      if(d.achievements) S.achievements = d.achievements;
    }
  } catch(err) {
    console.warn('Firebase load error:', err);
  }
}

async function fbSaveConfig(){
  try {
    await setDoc(doc(db,'app','config'),{
      users: S.users,
      tsamItems: S.tsamItems,
      achieveTopics: S.achieveTopics,
      shatzalTypes: S.shatzalTypes,
    });
  } catch(err){ console.warn('Firebase save config error:', err); }
}

async function fbSaveData(){
  try {
    await setDoc(doc(db,'app','data'),{
      reqs: S.reqs,
      daily: S.daily,
      tanks: S.tanks,
      scheds: S.scheds,
      special: S.special,
      tsamReports: S.tsamReports,
      achievements: S.achievements,
    });
  } catch(err){ console.warn('Firebase save data error:', err); }
}

// Live listener â€” updates all connected clients in real time
function fbListen(){
  onSnapshot(doc(db,'app','config'), (snap)=>{
    if(!snap.exists()) return;
    const d = snap.data();
    var wasMe = S.me ? S.me.id : null;
    if(d.users){ S.users = d.users; if(wasMe) S.me = S.users.find(u=>u.id===wasMe)||S.me; }
    if(d.tsamItems) S.tsamItems = d.tsamItems;
    if(d.achieveTopics) S.achieveTopics = d.achieveTopics;
    if(d.shatzalTypes) S.shatzalTypes = d.shatzalTypes;
    if(S.page==='app') render();
  });
  onSnapshot(doc(db,'app','data'), (snap)=>{
    if(!snap.exists()) return;
    const d = snap.data();
    if(d.reqs) S.reqs = d.reqs;
    if(d.daily) S.daily = d.daily;
    if(d.tanks) S.tanks = d.tanks;
    if(d.scheds) S.scheds = d.scheds;
    if(d.special) S.special = d.special;
    if(d.tsamReports) S.tsamReports = d.tsamReports;
    if(d.achievements) S.achievements = d.achievements;
    if(S.page==='app') render();
  });
}

// expose to global scope for the main script
window.fbSaveConfig = fbSaveConfig;
window.fbSaveData = fbSaveData;

// Boot
fbLoad().then(()=>{
  fbListen();
  render();
});
</script>

<script>
var S={
  page:'login',tab:'',modal:'',me:null,
  users:[
    {id:1,un:'admin',pw:'admin123',role:'admin',name:'×× ×”×œ ××¢×¨×›×ª',cid:null,mid:null,team:null},
    {id:8,un:'maf1',pw:'1234',role:'maf',name:'××¤ ××‘×¨×”×',cid:null,mid:null,team:null},
    {id:9,un:'smaf1',pw:'1234',role:'smaf',name:'×¡××¤ ×’×•×œ×Ÿ',cid:null,mid:null,team:null},
    {id:2,un:'mm1',pw:'1234',role:'mm',name:'×× ×›×”×Ÿ',cid:null,mid:null,team:'×’'},
    {id:3,un:'cmd1',pw:'1234',role:'commander',name:'××˜×§ ×œ×•×™',cid:null,mid:2,team:'1'},
    {id:4,un:'cmd2',pw:'1234',role:'commander',name:'××˜×§ ×‘×¨×§',cid:null,mid:2,team:'2'},
    {id:5,un:'sol1',pw:'1234',role:'soldier',name:'×˜×•×¨××™ ××œ×•×Ÿ',cid:3,mid:2,team:'1×'},
    {id:6,un:'sol2',pw:'1234',role:'soldier',name:'×˜×•×¨××™ ×“×•×“',cid:3,mid:2,team:'1×‘'},
    {id:7,un:'sol3',pw:'1234',role:'soldier',name:'×˜×•×¨××™ ×™×•×¡×™',cid:4,mid:2,team:'2×'},
  ],
  reqs:[],daily:[],tanks:[],scheds:[],special:[],
  tsamReports:[],
  achievements:{}, // {userId: {topicId: true/false}}
  achieveTopics:[
    {id:'t1',name:'××™×¤×•×¡ × ×©×§ ××™×©×™',prof:null},
    {id:'t2',name:'×©×™×¢×•×¨ ×¢×–×¨×” ×¨××©×•× ×”',prof:null},
    {id:'t3',name:'×ª×¨×’×•×œ×•×ª ×¦×•×•×ª',prof:null},
    {id:'t4',name:'×ª×¨×’×•×œ×•×ª ×¦×•×•×ª ××ª×§×“×',prof:null},
    {id:'t5',name:'×©×™×¢×•×¨ ×ª×•×“×',prof:null},
  ],
  shatzalTypes:[
    {id:'sh1',name:'×œ×›×œ× ×™×ª'},
    {id:'sh2',name:'×—×¥'},
    {id:'sh3',name:'×—×œ×•×œ'},
    {id:'sh4',name:'×—×¦×‘'},
    {id:'sh5',name:'×××’'},
    {id:'sh6',name:'0.5'},
  ],
  tsamItems:[
    {id:1,cat:'××§×œ×¢×™×',name:'×××’ 1'},
    {id:2,cat:'××§×œ×¢×™×',name:'×××’ 2'},
    {id:3,cat:'××§×œ×¢×™×',name:'×××’ 3'},
    {id:4,cat:'××§×œ×¢×™×',name:'××§×›'},
    {id:5,cat:'×¦×œ× ××™×©×™',name:'××•×œ×¨'},
    {id:6,cat:'×¦×œ× ××™×©×™',name:'×›×‘×™×© ×™×¨×•×§'},
    {id:7,cat:'×¦×œ× ××™×©×™',name:'×™×¢×˜'},
    {id:8,cat:'×ª×§×©×•×‘',name:'×ª×§×©×•×‘ 1'},
    {id:9,cat:'×ª×§×©×•×‘',name:'×ª×§×©×•×‘ 2'},
    {id:10,cat:'×¨×™××•× ×™×',name:'×¨×™××•× ×™ ×¨×¡×¡',type:'count',maxCount:6},
  ],
  lu:'',lp:'',lerr:'',ltab:'pass',
  fp:0,fsc:false,fdn:false,
  fd:{},eid:null,
};
var RL={admin:'×× ×”×œ',miflag:'××¤×œ×’',maf:'××¤',smaf:'×¡××¤',mm:'××',commander:'××˜×§',soldier:'×—×™×™×œ'};
var RC={admin:'#ff6b35',miflag:'#be185d',maf:'#dc2626',smaf:'#ea580c',mm:'#7c3aed',commander:'#1d4ed8',soldier:'#059669'};

function e(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function emp(t){return '<p style="color:#334155;text-align:center;padding:36px 0">'+t+'</p>';}
function fld(l,h){return '<div class="fld"><label>'+l+'</label>'+h+'</div>';}
function gv(id){var el=document.getElementById(id);return el?el.value:'';}
function bdg(s){var m={pending:['rgba(245,158,11,0.15)','#f59e0b','×××ª×™×Ÿ'],approved:['rgba(34,197,94,0.15)','#22c55e','××•×©×¨'],rejected:['rgba(239,68,68,0.15)','#ef4444','× ×“×—×”']};var x=m[s]||m.pending;return '<span style="background:'+x[0]+';color:'+x[1]+';padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600">'+x[2]+'</span>';}

// tabs config
function getTabs(){
  var r=S.me.role,nr=myR(),cr=cmdR(),mr=mmR();
  if(r==='soldier')return [{id:'daily',ic:'ğŸ“‹',lb:'×“×¨×™×©×•×ª ×™×•××™×•×ª',bg:0},{id:'reqs',ic:'ğŸ“¤',lb:'×‘×§×©×•×ª ×™×¦×™××”',bg:nr.filter(function(x){return x.status==='pending'}).length},{id:'achieve',ic:'ğŸ†',lb:'×”×©×’×™×',bg:0},{id:'sched',ic:'ğŸ“…',lb:'×œ×•×– ××™×©×™',bg:0}];
  if(r==='commander')return [{id:'reqs',ic:'ğŸ“¤',lb:'×‘×§×©×•×ª ×™×¦×™××”',bg:cr.filter(function(x){return x.status==='pending'}).length},{id:'tanks',ic:'ğŸ›¡',lb:'×“×™×•×•×—×™ ×˜× ×§',bg:0},{id:'tsalam',ic:'ğŸ“¸',lb:'×“×•×— ×¦×œ×',bg:0},{id:'achieve',ic:'ğŸ†',lb:'×”×©×’×™×',bg:0},{id:'sched',ic:'ğŸ“…',lb:'×œ×•×– ××™×©×™',bg:0}];
  if(r==='mm')return [{id:'reqs',ic:'ğŸ“¤',lb:'×‘×§×©×•×ª ××—×œ×§×”',bg:mr.filter(function(x){return x.status==='pending'}).length},{id:'tanks',ic:'ğŸ›¡',lb:'×“×™×•×•×—×™ ×˜× ×§',bg:0},{id:'tsalam',ic:'ğŸ“¸',lb:'×“×•×— ×¦×œ×',bg:0},{id:'achieve',ic:'ğŸ†',lb:'×”×©×’×™×',bg:0},{id:'special',ic:'â­',lb:'×‘×§×©×•×ª ××™×•×—×“×•×ª',bg:0},{id:'sched',ic:'ğŸ“…',lb:'×œ×•×– ××™×©×™',bg:0}];
  if(r==='smaf'||r==='maf'){
    var allPend=S.reqs.filter(function(x){return x.status==='pending'}).length;
    return [{id:'reqs',ic:'ğŸ“¤',lb:'×›×œ ×”×‘×§×©×•×ª',bg:allPend},{id:'tanks',ic:'ğŸ›¡',lb:'×“×™×•×•×—×™ ×˜× ×§',bg:0},{id:'tsalam',ic:'ğŸ“¸',lb:'×“×•×— ×¦×œ×',bg:0},{id:'achieve',ic:'ğŸ†',lb:'×”×©×’×™×',bg:0},{id:'special',ic:'â­',lb:'×‘×§×©×•×ª ××™×•×—×“×•×ª',bg:0},{id:'sched',ic:'ğŸ“…',lb:'×œ×•×– ××™×©×™',bg:0}];
  }
  if(r==='miflag'){
    var allPend2=S.reqs.filter(function(x){return x.status==='pending'}).length;
    return [{id:'overview',ic:'ğŸ“Š',lb:'×¡×§×™×¨×”',bg:0},{id:'reqs',ic:'ğŸ“¤',lb:'×›×œ ×”×‘×§×©×•×ª',bg:allPend2},{id:'tanks',ic:'ğŸ›¡',lb:'×“×™×•×•×—×™ ×˜× ×§',bg:0},{id:'tsalam',ic:'ğŸ“¸',lb:'×“×•×— ×¦×œ×',bg:0},{id:'achieve',ic:'ğŸ†',lb:'×”×©×’×™×',bg:0},{id:'special',ic:'â­',lb:'×‘×§×©×•×ª ××™×•×—×“×•×ª',bg:S.special.filter(function(x){return x.status==='pending'}).length},{id:'sched',ic:'ğŸ“…',lb:'×œ×•×– ××™×©×™',bg:0}];
  }
  return [{id:'overview',ic:'ğŸ“Š',lb:'×¡×§×™×¨×”',bg:S.reqs.filter(function(x){return x.status==='pending'}).length+S.special.filter(function(x){return x.status==='pending'}).length},{id:'team',ic:'ğŸ‘¥',lb:'× ×™×”×•×œ ×¦×•×•×ª',bg:0},{id:'reqs',ic:'ğŸ“‹',lb:'×›×œ ×”×‘×§×©×•×ª',bg:S.reqs.filter(function(x){return x.status==='pending'}).length},{id:'achieve',ic:'ğŸ†',lb:'× ×™×”×•×œ ×”×©×’×™×',bg:0},{id:'sched',ic:'ğŸ“…',lb:'× ×™×”×•×œ ×œ×•×–×™×',bg:0},{id:'tanks',ic:'ğŸ›¡',lb:'×“×™×•×•×—×™ ×˜× ×§',bg:0},{id:'tsalam',ic:'ğŸ“¸',lb:'×“×•×— ×¦×œ×',bg:0},{id:'special',ic:'â­',lb:'×‘×§×©×•×ª ××™×•×—×“×•×ª',bg:S.special.filter(function(x){return x.status==='pending'}).length}];
}
function myR(){return S.reqs.filter(function(r){return r.uid===S.me.id});}
function cmdR(){var ids=S.users.filter(function(u){return u.cid===S.me.id}).map(function(u){return u.id});ids.push(S.me.id);return S.reqs.filter(function(r){return ids.indexOf(r.uid)>-1});}
function mmR(){var ids=S.users.filter(function(u){return u.mid===S.me.id&&u.role!=='admin'}).map(function(u){return u.id});ids.push(S.me.id);return S.reqs.filter(function(r){return ids.indexOf(r.uid)>-1});}
function mmT(){var ids=S.users.filter(function(u){return u.mid===S.me.id&&u.role!=='admin'}).map(function(u){return u.id});ids.push(S.me.id);return S.tanks.filter(function(r){return ids.indexOf(r.uid)>-1});}

function render(){
  document.getElementById('root').innerHTML=S.page==='login'?rLogin():rApp();
  // sync inputs after render
  var lu=document.getElementById('lu');if(lu)lu.addEventListener('input',function(){S.lu=this.value;S.lerr='';});
  var lp=document.getElementById('lp');if(lp)lp.addEventListener('input',function(){S.lp=this.value;S.lerr='';});
}

function rLogin(){
  return '<div style="min-height:100vh;background:linear-gradient(135deg,#080d1a,#0d1b2a,#120820);display:flex;align-items:center;justify-content:center">'+
    '<div style="width:360px;background:rgba(10,16,30,0.98);border-radius:22px;border:1px solid rgba(255,255,255,0.08);padding:36px 30px;box-shadow:0 40px 80px rgba(0,0,0,0.8)">'+
      '<div style="text-align:center;margin-bottom:24px">'+
        '<div style="width:60px;height:60px;background:linear-gradient(135deg,#1d4ed8,#7c3aed);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:28px">ğŸ›¡ï¸</div>'+
        '<h1 style="font-size:20px;font-weight:700;margin-bottom:4px">××¢×¨×›×ª ×¤×œ×•×’×ª ××™×œ×•××™×</h1>'+
        '<p style="color:#475569;font-size:12px">×’×™×©×” ×××•×‘×˜×—×ª ×‘×œ×‘×“</p>'+
      '</div>'+
      '<div style="display:flex;background:rgba(255,255,255,0.04);border-radius:10px;padding:4px;margin-bottom:18px">'+
        ['pass','face'].map(function(id,i){var lb=['ğŸ”‘ ×¡×™×¡××”','ğŸ‘¤ ×–×™×”×•×™ ×¤× ×™×'][i];var on=S.ltab===id;return '<button onclick="setLTab(\''+id+'\')" style="flex:1;padding:8px 0;border:none;border-radius:8px;background:'+(on?'rgba(29,78,216,0.85)':'transparent')+';color:'+(on?'white':'#64748b')+';font-size:13px;font-weight:'+(on?600:400)+';cursor:pointer;font-family:inherit">'+lb+'</button>';}).join('')+
      '</div>'+
      '<div class="fld"><label>×©× ××©×ª××©</label><input class="inp" id="lu" value="'+e(S.lu)+'" placeholder="×”×–×Ÿ ×©× ××©×ª××©"/></div>'+
      (S.ltab==='pass'?
        '<div class="fld"><label>×¡×™×¡××”</label><input class="inp" type="password" id="lp" value="'+e(S.lp)+'" placeholder="×”×–×Ÿ ×¡×™×¡××”" onkeydown="if(event.key===\'Enter\')doLogin()"/></div>'+
        (S.lerr?'<p style="color:#ef4444;font-size:13px;margin-bottom:8px">'+S.lerr+'</p>':'')+
        '<button class="btn bblue" style="width:100%;margin-top:4px" onclick="doLogin()">×›× ×™×¡×”</button>'
      :rFace())+
      '<div style="margin-top:16px;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.04)">'+
        '<p style="color:#334155;font-size:11px;text-align:center;margin-bottom:4px">ğŸ‘‡ ××©×ª××©×™ ×“×•×’××”</p>'+
        [['admin','admin123','×× ×”×œ'],['maf1','1234','××¤'],['smaf1','1234','×¡××¤'],['mm1','1234','××'],['cmd1','1234','××˜×§'],['sol1','1234','×—×™×™×œ']].map(function(r){return '<p style="color:#475569;font-size:11px;text-align:center"><b style="color:#64748b">'+r[0]+'</b> / '+r[1]+' ('+r[2]+')</p>';}).join('')+
      '</div>'+
    '</div>'+
  '</div>';
}

function rFace(){
  var bc=S.fdn?'#22c55e':S.fsc?'#60a5fa':'#334155';
  var ic=S.fdn?'âœ…':'ğŸ‘¤';
  var tx=S.fdn?'×–×•×”×™×ª ×‘×”×¦×œ×—×”!':S.fsc?'×¡×•×¨×§... '+S.fp+'%':'×œ×—×¥ ×œ×¡×¨×™×§×ª ×¤× ×™×';
  return '<div style="text-align:center;margin:14px 0">'+
    '<div onclick="startFace()" style="width:110px;height:110px;border-radius:50%;border:3px solid '+bc+';margin:0 auto 8px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;background:rgba(30,41,59,0.4)">'+
      '<span style="font-size:42px;position:relative;z-index:1">'+ic+'</span>'+
      (S.fsc?'<div style="position:absolute;left:0;right:0;height:2px;background:#60a5fa;top:'+S.fp+'%;box-shadow:0 0 8px #60a5fa;z-index:2"></div>':'')+
    '</div>'+
    '<p style="color:'+(S.fdn?'#22c55e':'#64748b')+';font-size:13px">'+tx+'</p>'+
    (S.lerr?'<p style="color:#ef4444;font-size:13px;margin-top:6px">'+S.lerr+'</p>':'')+
  '</div>';
}

function rApp(){
  var rc=RC[S.me.role],tabs=getTabs();
  var notif=0;
  if(S.me.role==='commander')notif=cmdR().filter(function(x){return x.status==='pending'}).length;
  if(S.me.role==='mm')notif=mmR().filter(function(x){return x.status==='pending'}).length;
  if(S.me.role==='admin'||S.me.role==='miflag')notif=S.reqs.filter(function(x){return x.status==='pending'}).length+S.special.filter(function(x){return x.status==='pending'}).length;
  return '<div style="min-height:100vh;display:flex;flex-direction:column">'+
    '<div class="topbar">'+
      '<div style="display:flex;align-items:center;gap:8px"><span style="font-size:20px">ğŸ›¡ï¸</span><span style="font-weight:700;font-size:14px">×¤×œ×•×’×ª ××™×œ×•××™×</span></div>'+
      '<div style="display:flex;align-items:center;gap:10px">'+
        (notif?'<span style="background:#ef4444;color:white;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px">ğŸ”” '+notif+'</span>':'')+
        '<div class="av" style="background:'+rc+'22;border:2px solid '+rc+';color:'+rc+'">'+S.me.name[0]+'</div>'+
        '<span style="font-size:12px;font-weight:600">'+e(S.me.name)+'</span>'+
        '<button class="btn" onclick="logout()" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);color:#ef4444;font-size:12px;padding:5px 10px">×™×¦×™××”</button>'+
      '</div>'+
    '</div>'+
    '<div class="tabs">'+
      tabs.map(function(t){var on=S.tab===t.id;return '<button class="tab-btn'+(on?' on':'')+'" style="--c:'+rc+'" onclick="setTab(\''+t.id+'\')">'+t.ic+' '+t.lb+(t.bg?'<span style="background:#ef4444;color:white;font-size:9px;padding:1px 5px;border-radius:10px;font-weight:700;margin-right:4px">'+t.bg+'</span>':'')+'</button>';}).join('')+
    '</div>'+
    '<div class="content">'+rContent()+'</div>'+
    (S.modal?rModal():'')+
  '</div>';
}

function rContent(){
  var r=S.me.role,t=S.tab;
  if(t==='daily')return rDaily();
  if(t==='reqs'){
    if(r==='soldier')return rReqs(myR(),false);
    if(r==='commander')return rReqs(cmdR(),true);
    if(r==='mm')return rReqs(mmR(),true);
    return rReqs(S.reqs,true);
  }  if(t==='tanks'){return rTanks(r==='mm'?mmT():r==='miflag'||r==='admin'?S.tanks:S.tanks.filter(function(x){return x.uid===S.me.id}),r==='admin'||r==='maf'||r==='smaf'||r==='miflag');}
  if(t==='tsalam')return rTsalam();
  if(t==='achieve')return rAchieve();
  if(t==='sched')return rSched();
  if(t==='special'){
    if(r==='mm')return rSpecial(S.special.filter(function(x){return x.uid===S.me.id}),false);
    return rSpecial(S.special,true);
  }
  if(t==='overview')return rOverview();
  if(t==='team')return rTeam();
  return emp('×‘×—×¨ ×§×˜×’×•×¨×™×” ××”×ª×¤×¨×™×˜ ×œ××¢×œ×”');
}

function rDaily(){
  var items=S.daily.filter(function(r){return r.uid===S.me.id});
  return '<div>'+
    hdr('ğŸ“‹ ×“×¨×™×©×•×ª ×™×•××™×•×ª','<button class="btn bgreen" onclick="openM(\'daily\')">+ ×“×™×•×•×— ×™×•××™</button>')+
    (items.length?items.map(function(r){return '<div class="card"><p style="font-weight:600;margin-bottom:4px">×“×™×•×•×— ×™×•××™</p><p style="color:#94a3b8;font-size:13px;margin-bottom:4px">'+e(r.content)+'</p>'+(r.cat?'<span style="background:rgba(255,255,255,0.06);color:#64748b;font-size:11px;padding:2px 8px;border-radius:8px">'+e(r.cat)+'</span>':'')+'</div>';}).join(''):emp('××™×Ÿ ×“×™×•×•×—×™×. ×œ×—×¥ "+ ×“×™×•×•×— ×™×•××™" ×œ×”×•×¡×¤×”'))+
  '</div>';
}

function rReqs(items,ca){
  var r=S.me.role;
  var bc=r==='mm'?'bpurple':r==='admin'?'borange':'bblue';
  var bl=r==='soldier'?'+ ×‘×§×©×” ×—×“×©×”':'+ ×‘×§×©×” ×©×œ×™';
  return '<div>'+
    hdr('ğŸ“¤ ×‘×§×©×•×ª ×™×¦×™××”','<button class="btn '+bc+'" onclick="openM(\'req\')">'+bl+'</button>')+
    (items.length?items.map(function(q){
      var u=S.users.find(function(x){return x.id===q.uid});
      return '<div class="card"><div style="display:flex;justify-content:space-between;align-items:flex-start">'+
        '<div style="flex:1">'+
          '<div style="display:flex;gap:6px;align-items:center;margin-bottom:4px;flex-wrap:wrap">'+
            '<span style="font-weight:600">'+e(q.uname)+'</span>'+
            (u?'<span style="background:rgba(255,255,255,0.06);color:#94a3b8;font-size:11px;padding:2px 6px;border-radius:8px">'+RL[u.role]+'</span>':'')+
            (q.uid===S.me.id?'<span style="background:rgba(29,78,216,0.2);color:#60a5fa;font-size:11px;padding:2px 6px;border-radius:8px">×× ×™</span>':'')+
          '</div>'+
          '<p style="color:#94a3b8;font-size:13px;margin-bottom:2px">'+e(q.reason)+'</p>'+
          '<p style="color:#475569;font-size:12px">'+e(q.date)+(q.dateTo&&q.dateTo!==q.date?' â€” '+e(q.dateTo):'')+' | '+e(q.st)+'â€“'+e(q.et)+'</p>'+
        '</div>'+
        '<div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end;flex-shrink:0;margin-right:8px">'+
          bdg(q.status)+
          (ca&&q.status==='pending'&&q.uid!==S.me.id?
            '<div style="display:flex;gap:4px">'+
              '<button class="bsm" style="background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);color:#22c55e" onclick="apR('+q.id+')">âœ“ ××©×¨</button>'+
              '<button class="bsm" style="background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);color:#ef4444" onclick="rejR('+q.id+')">âœ• ×“×—×”</button>'+
            '</div>':'')+
        '</div>'+
      '</div></div>';
    }).join(''):emp('××™×Ÿ ×‘×§×©×•×ª'))+
  '</div>';
}

function rTanks(items,isAdmin){
  var adminShatzalMgmt=isAdmin?
    '<div style="margin-bottom:20px">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">'+
        '<h3 style="color:#94a3b8;font-size:14px">×¡×•×’×™ ×ª×—××•×©×ª ×©×¦×œ</h3>'+
        '<button class="btn bpurple" onclick="openM(\'addshatzal\')" style="font-size:12px;padding:6px 12px">+ ×”×•×¡×£</button>'+
      '</div>'+
      '<div style="display:flex;flex-wrap:wrap;gap:6px">'+
        S.shatzalTypes.map(function(st){
          return '<div style="display:flex;align-items:center;gap:6px;background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.2);border-radius:8px;padding:6px 10px">'+
            '<span style="font-size:13px;color:#a78bfa">'+e(st.name)+'</span>'+
            '<button onclick="editShatzal(\''+st.id+'\')" style="background:none;border:none;cursor:pointer;color:#60a5fa;font-size:12px">âœï¸</button>'+
            '<button onclick="delShatzal(\''+st.id+'\')" style="background:none;border:none;cursor:pointer;color:#ef4444;font-size:12px">âœ•</button>'+
          '</div>';
        }).join('')+
      '</div>'+
    '</div>'
  :'';

  return '<div>'+
    hdr('ğŸ›¡ ×“×™×•×•×—×™ ×˜× ×§',(!isAdmin?'<button class="btn bpurple" onclick="openTank()">+ ×“×™×•×•×— ×˜× ×§</button>':''))+
    adminShatzalMgmt+
    (items.length?items.map(function(r){
      var isF=r.type&&r.type.indexOf('×ª×§×œ×”')>-1;
      var isShatzal=r.type==='×©×¦×œ';
      return '<div class="card">'+
        '<div style="display:flex;gap:8px;align-items:center;margin-bottom:5px">'+
          '<span style="font-weight:600">×˜× ×§ '+e(r.tank)+'</span>'+
          '<span style="background:'+(isShatzal?'rgba(124,58,237,0.15)':isF?'rgba(239,68,68,0.15)':'rgba(34,197,94,0.15)')+';color:'+(isShatzal?'#a78bfa':isF?'#ef4444':'#22c55e')+';font-size:12px;padding:2px 8px;border-radius:8px">'+e(r.type)+'</span>'+
          (r.uname!==S.me.name?'<span style="color:#64748b;font-size:12px">| '+e(r.uname)+'</span>':'')+
        '</div>'+
        (isShatzal&&r.shatzal&&Object.keys(r.shatzal).length>0?
          '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px">'+
            S.shatzalTypes.filter(function(st){return r.shatzal[st.id]&&r.shatzal[st.id]>0;}).map(function(st){
              return '<span style="background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.2);color:#a78bfa;font-size:12px;padding:2px 8px;border-radius:6px">'+e(st.name)+': '+r.shatzal[st.id]+'</span>';
            }).join('')+
          '</div>'
        :
          (r.desc?'<p style="color:#94a3b8;font-size:13px">'+e(r.desc)+'</p>':'')
        )+
      '</div>';
    }).join(''):emp('××™×Ÿ ×“×™×•×•×—×™ ×˜× ×§'))+
  '</div>';
}

function rSched(){
  var isAdmin=S.me.role==='admin';
  var items=(isAdmin?S.scheds:S.scheds.filter(function(s){return s.uid===S.me.id})).slice().sort(function(a,b){return a.date.localeCompare(b.date)});
  return '<div>'+
    hdr('ğŸ“… '+(isAdmin?'× ×™×”×•×œ ×œ×•×–×™ ×™×¦×™××”':'×”×œ×•×– ×”××™×©×™ ×©×œ×™'),isAdmin?'<button class="btn bblue" onclick="openM(\'sched\')">+ ×”×•×¡×£ ×™×¦×™××”</button>':'')+
    (items.length?items.map(function(s){
      var u=S.users.find(function(x){return x.id===s.uid});
      return '<div class="card"><div style="display:flex;justify-content:space-between;align-items:center">'+
        '<div><p style="font-weight:600;margin-bottom:2px">'+(isAdmin&&u?e(u.name)+' â€” ':'')+e(s.reason)+'</p><p style="color:#64748b;font-size:13px">'+e(s.date)+' | '+e(s.st)+'â€“'+e(s.et)+'</p></div>'+
        '<span style="color:#1d4ed8;font-size:13px;font-weight:600">'+e(s.type)+'</span>'+
      '</div></div>';
    }).join(''):emp('××™×Ÿ ×™×¦×™××•×ª ××ª×•×–×× ×•×ª'))+
  '</div>';
}

function rSpecial(items,ca){
  return '<div>'+
    hdr('â­ ×‘×§×©×•×ª ××™×•×—×“×•×ª ×œ××¤×œ"×“',!ca?'<button class="btn borange" onclick="openM(\'special\')">+ ×‘×§×©×” ××™×•×—×“×ª</button>':'')+
    (items.length?items.map(function(r){
      return '<div class="card"><div style="display:flex;justify-content:space-between;align-items:flex-start">'+
        '<div><p style="font-weight:600;margin-bottom:3px">'+e(r.uname)+' â€” '+e(r.subj)+'</p><p style="color:#94a3b8;font-size:13px;margin-bottom:4px">'+e(r.content)+'</p>'+(r.prio?'<span style="background:rgba(255,107,53,0.15);color:#ff6b35;font-size:11px;padding:2px 8px;border-radius:8px">'+e(r.prio)+'</span>':'')+'</div>'+
        '<div style="display:flex;flex-direction:column;gap:5px;align-items:flex-end">'+
          bdg(r.status)+
          (ca&&r.status==='pending'?'<div style="display:flex;gap:4px"><button class="bsm" style="background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);color:#22c55e" onclick="apS('+r.id+')">âœ“ ××©×¨</button><button class="bsm" style="background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);color:#ef4444" onclick="rejS('+r.id+')">âœ• ×“×—×”</button></div>':'')+
        '</div>'+
      '</div></div>';
    }).join(''):emp('××™×Ÿ ×‘×§×©×•×ª ××™×•×—×“×•×ª'))+
  '</div>';
}

function rOverview(){
  var so=S.users.filter(function(u){return u.role==='soldier'});
  var cm=S.users.filter(function(u){return u.role==='commander'});
  var mm=S.users.filter(function(u){return u.role==='mm'});
  var maf=S.users.filter(function(u){return u.role==='maf'||u.role==='smaf'});
  var miflag=S.users.filter(function(u){return u.role==='miflag'});
  var stats=[
    {l:'×—×™×™×œ×™×',v:so.length,c:'#059669'},
    {l:'××˜×§',v:cm.length,c:'#1d4ed8'},
    {l:'××',v:mm.length,c:'#7c3aed'},
    {l:'××¤/×¡××¤',v:maf.length,c:'#dc2626'},
    {l:'××¤×œ×’',v:miflag.length,c:'#be185d'},
    {l:'×‘×§×©×•×ª ×××ª×™× ×•×ª',v:S.reqs.filter(function(x){return x.status==='pending'}).length,c:'#f59e0b'},
    {l:'×“×™×•×•×—×™ ×˜× ×§',v:S.tanks.length,c:'#ef4444'},
  ];
  return '<div>'+
    '<h2 style="font-size:18px;margin-bottom:16px">ğŸ“Š ×¡×§×™×¨×” ×›×œ×œ×™×ª</h2>'+
    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:20px">'+
      stats.map(function(s){return '<div class="card" style="margin-bottom:0"><p style="color:#64748b;font-size:12px;margin-bottom:6px">'+s.l+'</p><p style="color:'+s.c+';font-size:30px;font-weight:700">'+s.v+'</p></div>';}).join('')+
    '</div>'+
    '<h3 style="color:#94a3b8;font-size:14px;margin-bottom:10px">×‘×§×©×•×ª ××—×¨×•× ×•×ª</h3>'+
    (S.reqs.length?S.reqs.slice(-6).reverse().map(function(r){return '<div class="card"><div style="display:flex;justify-content:space-between;align-items:center"><span><b>'+e(r.uname)+'</b><span style="color:#64748b;font-size:13px"> â€” '+e(r.reason)+' | '+e(r.date)+'</span></span>'+bdg(r.status)+'</div></div>';}).join(''):emp('××™×Ÿ ×‘×§×©×•×ª ×¢×“×™×™×Ÿ'))+
  '</div>';
}

function rTeam(){
  var groups=[
    {role:'miflag',lb:'××¤×œ×’',c:'#be185d'},
    {role:'maf',lb:'××¤',c:'#dc2626'},
    {role:'smaf',lb:'×¡××¤',c:'#ea580c'},
    {role:'mm',lb:'××',c:'#7c3aed'},
    {role:'commander',lb:'××˜×§',c:'#1d4ed8'},
    {role:'soldier',lb:'×—×™×™×œ×™×',c:'#059669'},
  ];
  var cm=S.users.filter(function(u){return u.role==='commander'});
  var mm=S.users.filter(function(u){return u.role==='mm'});
  return '<div>'+
    hdr('ğŸ‘¥ × ×™×”×•×œ ×¦×•×•×ª','<button class="btn borange" onclick="openM(\'adduser\')">+ ×”×•×¡×£ ××©×ª××©</button>')+
    groups.map(function(g){
      var list=S.users.filter(function(u){return u.role===g.role});
      return '<div style="margin-bottom:20px">'+
        '<h3 style="color:'+g.c+';font-size:14px;margin-bottom:10px">'+g.lb+' ('+list.length+')</h3>'+
        '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px">'+
          list.map(function(u){
            var cmd=S.users.find(function(x){return x.id===u.cid});
            var mmx=S.users.find(function(x){return x.id===u.mid});
            return '<div class="card" style="margin-bottom:0"><div style="display:flex;justify-content:space-between;align-items:center">'+
              '<div style="display:flex;gap:8px;align-items:center">'+
                '<div class="av" style="background:'+g.c+'22;border:2px solid '+g.c+';color:'+g.c+'">'+u.name[0]+'</div>'+
                '<div><p style="font-weight:600;font-size:13px">'+e(u.name)+'</p><p style="color:#475569;font-size:11px">@'+e(u.un)+'</p>'+
                (u.prof?'<p style="color:#0891b2;font-size:10px;font-weight:600">âš™ '+e(u.prof)+'</p>':'')+
                (u.team?'<p style="color:#7c3aed;font-size:10px;font-weight:600">×¦×•×•×ª '+e(u.team)+'</p>':'')+
                (u.role==='mm'&&u.cids&&u.cids.length?'<p style="color:#334155;font-size:10px">××˜×§×™×: '+u.cids.map(function(id){var c=S.users.find(function(x){return x.id===id;});return c?e(c.name):'?';}).join(', ')+'</p>':'')+
                ((u.role==='commander'||u.role==='maf'||u.role==='smaf')&&u.solids&&u.solids.length?'<p style="color:#334155;font-size:10px">×—×™×™×œ×™×: '+u.solids.map(function(id){var c=S.users.find(function(x){return x.id===id;});return c?e(c.name):'?';}).join(', ')+'</p>':'')+
                (u.role==='soldier'&&(u.cid||u.mid)?'<p style="color:#334155;font-size:10px">'+(u.cid?(function(){var c=S.users.find(function(x){return x.id===u.cid;});return c?'××˜×§: '+e(c.name):'';})():'')+(u.mid?(function(){var m=S.users.find(function(x){return x.id===u.mid;});return m?' | ××: '+e(m.name):'';})():'')+'</p>':'')+
                '</div>'+
              '</div>'+
              '<div style="display:flex;gap:4px">'+
                '<button onclick="editU('+u.id+')" style="background:rgba(29,78,216,0.1);border:1px solid rgba(29,78,216,0.2);border-radius:7px;padding:5px;cursor:pointer;color:#60a5fa;font-size:13px">âœï¸</button>'+
                (u.id!==S.me.id?'<button onclick="delU('+u.id+')" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:7px;padding:5px;cursor:pointer;color:#ef4444;font-size:13px">ğŸ—‘</button>':'')+
              '</div>'+
            '</div></div>';
          }).join('')+
        '</div>'+
      '</div>';
    }).join('')+
  '</div>';
}

function rModal(){
  var m=S.modal;
  var titles={daily:'×“×™×•×•×— ×™×•××™',req:'×‘×§×©×ª ×™×¦×™××”',tank:'×“×™×•×•×— ×˜× ×§',special:'×‘×§×©×” ××™×•×—×“×ª ×œ××¤×œ"×“',adduser:'×”×•×¡×£ ××©×ª××©',edituser:'×¢×¨×™×›×ª ××©×ª××©',sched:'×”×•×¡×£ ×™×¦×™××” ×œ×œ×•×–',tsalam:'×©×œ×™×—×ª ×“×•×— ×¦×œ×',tsamitem:'×”×•×¡×£ ×¤×¨×™×˜ ×œ×“×•×—',edittsamitem:'×¢×¨×™×›×ª ×¤×¨×™×˜',addtopic:'×”×•×¡×£ × ×•×©× ×”×©×’×”',addshatzal:'×”×•×¡×£ ×¡×•×’ ×ª×—××•×©×ª',editshatzal:'×¢×¨×™×›×ª ×¡×•×’ ×ª×—××•×©×ª'};
  var cm=S.users.filter(function(u){return u.role==='commander'});
  var mm=S.users.filter(function(u){return u.role==='mm'});
  var na=S.users.filter(function(u){return u.role!=='admin'});
  var eu=m==='edituser'?S.users.find(function(u){return u.id===S.eid}):null;
  var ef=Object.assign({},eu||{},S._modalOverride||{});
  S._modalOverride=null;
  var body='';

  if(m==='daily'){
    body=fld('×ª×•×›×Ÿ','<textarea class="inp" id="fc" style="min-height:80px;resize:vertical"></textarea>')+
      fld('×§×˜×’×•×¨×™×”','<select class="inp" id="fcat"><option value="">×‘×—×¨</option>'+['×¦×™×•×“','×œ×•×’×™×¡×˜×™×§×”','×›×•×— ××“×','××—×¨'].map(function(o){return '<option>'+o+'</option>';}).join('')+'</select>')+
      '<button class="btn bgreen" style="width:100%;margin-top:14px" onclick="svDaily()">×©×œ×— ×“×™×•×•×—</button>';
  }else if(m==='req'){
    body=fld('×¡×™×‘×”','<input class="inp" id="fr" placeholder="×¡×™×‘×ª ×”×‘×§×©×”..."/>')+
      '<div class="grid2">'+fld('××ª××¨×™×š','<input class="inp" type="date" id="fd"/>')+fld('×¢×“ ×ª××¨×™×š','<input class="inp" type="date" id="fdt"/>')+'</div>'+
      '<div class="grid2">'+fld('××©×¢×”','<input class="inp" type="time" id="fst"/>')+fld('×¢×“ ×©×¢×”','<input class="inp" type="time" id="fet"/>')+'</div>'+
      fld('×”×¢×¨×•×ª','<textarea class="inp" id="fn" style="min-height:55px;resize:vertical"></textarea>')+
      '<button class="btn bblue" style="width:100%;margin-top:14px" onclick="svReq()">×©×œ×— ×‘×§×©×”</button>';
  }else if(m==='tank'){
    var shatzalSelected=S._tankTypeOverride==='×©×¦×œ';
    body=fld('××¡×¤×¨ ×˜× ×§','<input class="inp" id="ftk" placeholder="B-14" value="'+(S._tankNumOverride||'')+'"/>') +
      fld('×¡×•×’','<select class="inp" id="fty" onchange="onTankTypeChange(this.value)"><option value="">×‘×—×¨</option>'+
        ['×“×™×•×•×— ×©×’×¨×ª×™','×ª×§×œ×”','×ª×§×œ×” ×§×¨×™×˜×™×ª','×ª×—×–×•×§×”','×©×¦×œ'].map(function(o){
          return '<option'+(S._tankTypeOverride===o?' selected':'')+'>'+o+'</option>';
        }).join('')+
      '</select>') +
      (shatzalSelected?
        '<div style="background:rgba(124,58,237,0.08);border:1px solid rgba(124,58,237,0.2);border-radius:10px;padding:12px;margin-bottom:12px">'+
          '<p style="color:#a78bfa;font-size:13px;font-weight:600;margin-bottom:10px">×›××•×™×•×ª ×ª×—××•×©×ª ×©×¦×œ</p>'+
          S.shatzalTypes.map(function(st){
            return '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'+
              '<label style="color:#94a3b8;font-size:13px">'+e(st.name)+'</label>'+
              '<input type="number" min="0" id="sh_'+st.id+'" placeholder="0" '+
                'style="width:80px;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.07);color:white;font-size:14px;font-weight:600;text-align:center"/>'+
            '</div>';
          }).join('')+
        '</div>'
      :
        fld('×ª×™××•×¨','<textarea class="inp" id="fds" style="min-height:70px;resize:vertical"></textarea>')
      )+
      '<button class="btn bpurple" style="width:100%;margin-top:4px" onclick="svTank()">×©×œ×— ×“×™×•×•×—</button>';
  }else if(m==='special'){
    body=fld('× ×•×©×','<input class="inp" id="fsb"/>')+
      fld('×ª×•×›×Ÿ','<textarea class="inp" id="fc" style="min-height:70px;resize:vertical"></textarea>')+
      fld('×“×—×™×¤×•×ª','<select class="inp" id="fpr"><option value="">×‘×—×¨</option>'+['×¨×’×™×œ','×“×—×•×£','×§×¨×™×˜×™'].map(function(o){return '<option>'+o+'</option>';}).join('')+'</select>')+
      '<button class="btn borange" style="width:100%;margin-top:14px" onclick="svSpecial()">×©×œ×— ×‘×§×©×”</button>';
  }else if(m==='adduser'||m==='edituser'){
    var TEAMS=['×’','×“','1','1×','1×‘','2','2×','2×‘','3','3×','3×‘','××¨×—×¤×™×'];
    var roleVal=ef.role||'';
    var soldiers=S.users.filter(function(u){return u.role==='soldier'});
    var selOpt=function(id,arr,val){
      return '<select class="inp" id="'+id+'"><option value="">×œ×œ×</option>'+
        arr.map(function(u){return '<option value="'+u.id+'"'+(val===u.id?' selected':'')+'>'+e(u.name)+'</option>';}).join('')+
      '</select>';
    };
    // multi-select helper â€” renders N dropdowns for picking up to N items from a list
    var multiSel=function(prefix,arr,vals,n){
      var rows='';
      for(var i=0;i<n;i++){
        var curVal=(vals&&vals[i])||null;
        rows+='<div style="margin-bottom:6px"><select class="inp" id="'+prefix+i+'"><option value="">×œ×œ×</option>'+
          arr.map(function(u){return '<option value="'+u.id+'"'+(curVal===u.id?' selected':'')+'>'+e(u.name)+'</option>';}).join('')+
        '</select></div>';
      }
      return rows;
    };

    body=
      fld('×©× ××œ×','<input class="inp" id="fn" value="'+e(ef.name||'')+'"/>') +
      fld('×©× ××©×ª××©','<input class="inp" id="fun" value="'+e(ef.un||'')+'"/>') +
      fld('×¡×™×¡××”','<input class="inp" id="fpw" value="'+e(ef.pw||'')+'"/>') +
      fld('×ª×¤×§×™×“','<select class="inp" id="frl" onchange="reRenderModal()"><option value="">×‘×—×¨</option>'+
        ['soldier','commander','mm','maf','smaf','miflag','admin'].map(function(o){return '<option value="'+o+'"'+(roleVal===o?' selected':'')+'>'+RL[o]+'</option>';}).join('')+
      '</select>') +
      fld('×¦×•×•×ª','<select class="inp" id="ftm"><option value="">×œ×œ×</option>'+
        TEAMS.map(function(t){return '<option'+(ef.team===t?' selected':'')+'>'+t+'</option>';}).join('')+
      '</select>') +
      (roleVal!=='admin'?
        fld('××§×¦×•×¢','<select class="inp" id="fprof"><option value="">×œ×œ×</option>'+
          ['××¤×§×“','×ª×•×ª×—×Ÿ','×˜×¢×Ÿ','× ×”×’'].map(function(p){return '<option'+(ef.prof===p?' selected':'')+'>'+p+'</option>';}).join('')+
        '</select>') : '') +
      (roleVal==='mm' ?
        '<div class="fld"><label>××˜×§ (×¢×“ 2)</label>'+multiSel('fci',cm,ef.cids,2)+'</div>'
      : roleVal==='commander'||roleVal==='maf'||roleVal==='smaf' ?
        '<div class="fld"><label>×—×™×™×œ×™× (×¢×“ 4)</label>'+multiSel('fsol',soldiers,ef.solids,4)+'</div>'
      : roleVal==='soldier' ?
        fld('××˜×§',selOpt('fci',cm,ef.cid)) +
        fld('××',selOpt('fmi',mm,ef.mid))
      : '') +
      '<button class="btn borange" style="width:100%;margin-top:14px" onclick="svUser(\''+m+'\')">'+(m==='edituser'?'×©××•×¨ ×©×™× ×•×™×™×':'×”×•×¡×£ ××©×ª××©')+'</button>';
  }else if(m==='tsalam'){
    var now2=new Date();
    var dd=now2.getFullYear()+'-'+(String(now2.getMonth()+1).padStart(2,'0'))+'-'+(String(now2.getDate()).padStart(2,'0'));
    var cnt=Object.keys(S._pendingTsamVals||{}).length;
    body='<div style="background:rgba(8,130,192,0.08);border:1px solid rgba(8,130,192,0.2);border-radius:10px;padding:12px;margin-bottom:14px">'+
        '<p style="color:#38bdf8;font-size:13px">'+cnt+' ×¤×¨×™×˜×™× ×™××•×œ××• ×‘×“×•×—.</p>'+
        '<p style="color:#64748b;font-size:12px;margin-top:4px">×× ×›×‘×¨ ×§×™×™× ×“×•×— ×œ×”×™×•× â€” ×”×•× ×™×ª×¢×“×›×Ÿ.</p>'+
      '</div>'+
      fld('×ª××¨×™×š','<input class="inp" type="date" id="ftd" value="'+dd+'"/>') +
      '<button class="btn" style="width:100%;margin-top:4px;background:linear-gradient(135deg,#0891b2,#0e7490)" onclick="svTsalam()">ğŸ“¤ ×©×œ×— ×“×•×—</button>';
  }else if(m==='tsamitem'||m==='edittsamitem'){
    var eti=m==='edittsamitem'?S.tsamItems.find(function(x){return x.id===S._tsamEditId;}):null;
    var cats2=[...new Set(S.tsamItems.map(function(x){return x.cat;}))];
    body=fld('×©× ×¤×¨×™×˜','<input class="inp" id="ftiname" value="'+e(eti?eti.name:'')+'"/>') +
      fld('×§×˜×’×•×¨×™×”',
        '<input class="inp" id="fticat" list="catlist" value="'+e(eti?eti.cat:'')+'" placeholder="×”×§×œ×“ ××• ×‘×—×¨ ×§×˜×’×•×¨×™×”"/>'+
        '<datalist id="catlist">'+cats2.map(function(c){return '<option value="'+e(c)+'"/>';}).join('')+'</datalist>'
      )+
      '<button class="btn borange" style="width:100%;margin-top:14px" onclick="svTsamItem(\''+m+'\')">'+(m==='edittsamitem'?'×©××•×¨ ×©×™× ×•×™×™×':'×”×•×¡×£ ×¤×¨×™×˜')+'</button>';
  }else if(m==='addshatzal'||m==='editshatzal'){
    var esh=m==='editshatzal'?S.shatzalTypes.find(function(x){return x.id===S._shatzalEditId;}):null;
    body=fld('×©× ×¡×•×’ ×ª×—××•×©×ª','<input class="inp" id="fshname" value="'+e(esh?esh.name:'')+'"/>') +
      '<button class="btn bpurple" style="width:100%;margin-top:14px" onclick="svShatzal(\''+m+'\')">'+(m==='editshatzal'?'×©××•×¨ ×©×™× ×•×™×™×':'×”×•×¡×£')+'</button>';
  }else if(m==='addtopic'){
    body=fld('×©× ×”× ×•×©×','<input class="inp" id="ftopicname" placeholder="×œ××©×œ: ×©×™×¢×•×¨ ×˜×§×˜×™×§×”"/>') +
      fld('××§×¦×•×¢ (××•×¤×¦×™×•× ×œ×™)','<select class="inp" id="ftopicprof"><option value="">×œ×›×•×œ×</option>'+
        ['××¤×§×“','×ª×•×ª×—×Ÿ','×˜×¢×Ÿ','× ×”×’'].map(function(p){return '<option>'+p+'</option>';}).join('')+
      '</select>') +
      '<button class="btn bgreen" style="width:100%;margin-top:14px" onclick="svTopic()">+ ×”×•×¡×£ × ×•×©×</button>';
  }else if(m==='sched'){
    body=fld('×‘×—×¨ ××©×ª××©','<select class="inp" id="fuid"><option value="">×‘×—×¨</option>'+na.map(function(u){return '<option value="'+u.id+'">'+e(u.name)+' ('+RL[u.role]+')</option>';}).join('')+'</select>')+
      fld('×ª××¨×™×š','<input class="inp" type="date" id="fd"/>')+
      '<div class="grid2">'+fld('××©×¢×”','<input class="inp" type="time" id="fst"/>')+fld('×¢×“ ×©×¢×”','<input class="inp" type="time" id="fet"/>')+'</div>'+
      fld('×¡×™×‘×”','<input class="inp" id="fr"/>')+
      fld('×¡×•×’ ×™×¦×™××”','<select class="inp" id="fty"><option value="">×‘×—×¨</option>'+['×™×¦×™××” ×¨×’×™×œ×”','×—×•×¤×©×”','×˜×™×¤×•×œ ×¨×¤×•××™','×”×›×©×¨×”','××—×¨'].map(function(o){return '<option>'+o+'</option>';}).join('')+'</select>')+
      '<button class="btn bblue" style="width:100%;margin-top:14px" onclick="svSched()">×”×•×¡×£ ×œ×œ×•×–</button>';
  }

  return '<div class="overlay" onclick="if(event.target===this)closeM()">'+
    '<div class="modal-box">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">'+
        '<h3 style="font-size:17px">'+titles[m]+'</h3>'+
        '<button onclick="closeM()" style="background:none;border:none;cursor:pointer;color:#64748b;font-size:20px;font-family:inherit">âœ•</button>'+
      '</div>'+body+
    '</div>'+
  '</div>';
}

function rAchieve(){
  var isAdmin=S.me.role==='admin';

  if(isAdmin){
    var nonAdmins=S.users.filter(function(u){return u.role!=='admin';});
    var expandUid=S._achExpand||null;

    return '<div>'+
      hdr('ğŸ† × ×™×”×•×œ ×”×©×’×™×',
        '<button class="btn bgreen" onclick="openM(\'addtopic\')" style="font-size:13px;padding:8px 14px">+ ×”×•×¡×£ × ×•×©×</button>'
      )+
      // Topics list with delete
      '<div style="margin-bottom:24px">'+
        '<h3 style="color:#94a3b8;font-size:14px;margin-bottom:12px">× ×•×©××™ ×”×©×’×™× ×‘××¢×¨×›×ª</h3>'+
        (function(){
          var byProf={};
          S.achieveTopics.forEach(function(t){
            var k=t.prof||'×›×•×œ×';
            if(!byProf[k])byProf[k]=[];
            byProf[k].push(t);
          });
          return Object.keys(byProf).map(function(prof){
            return '<div style="margin-bottom:12px">'+
              '<p style="color:#0891b2;font-size:12px;font-weight:700;margin-bottom:6px">'+e(prof)+'</p>'+
              '<div style="display:flex;flex-wrap:wrap;gap:6px">'+
                byProf[prof].map(function(t){
                  return '<div style="display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:6px 10px">'+
                    '<span style="font-size:13px">'+e(t.name)+'</span>'+
                    '<button onclick="delTopic(\''+t.id+'\')" style="background:none;border:none;cursor:pointer;color:#475569;font-size:12px">âœ•</button>'+
                  '</div>';
                }).join('')+
              '</div>'+
            '</div>';
          }).join('');
        })()+
      '</div>'+
      // Per-user cards
      '<h3 style="color:#94a3b8;font-size:14px;margin-bottom:12px">×”×©×’×™× ×œ×¤×™ ××©×ª××©</h3>'+
      nonAdmins.map(function(u){
        var rc2=RC[u.role]||'#64748b';
        var userAch=S.achievements[u.id]||{};
        var relevantTopics=S.achieveTopics.filter(function(t){return !t.prof||t.prof===u.prof;});
        var done=relevantTopics.filter(function(t){return userAch[t.id];}).length;
        var total=relevantTopics.length;
        var pct=total>0?Math.round(done/total*100):0;
        var isOpen=expandUid===u.id;
        return '<div class="card" style="margin-bottom:8px">'+
          '<div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleAchExpand('+u.id+')">'+
            '<div style="display:flex;align-items:center;gap:10px">'+
              '<div class="av" style="background:'+rc2+'22;border:2px solid '+rc2+';color:'+rc2+'">'+u.name[0]+'</div>'+
              '<div>'+
                '<p style="font-weight:600;font-size:14px">'+e(u.name)+'</p>'+
                '<p style="color:#64748b;font-size:12px">'+RL[u.role]+(u.prof?' | '+e(u.prof):'')+(u.team?' | ×¦×•×•×ª '+e(u.team):'')+'</p>'+
              '</div>'+
            '</div>'+
            '<div style="display:flex;align-items:center;gap:10px">'+
              '<div style="text-align:center">'+
                '<p id="ach-prog-'+u.id+'" style="font-size:13px;font-weight:700;color:'+(pct===100?'#22c55e':pct>50?'#f59e0b':'#64748b')+'">'+done+'/'+total+'</p>'+
                '<div style="width:60px;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;margin-top:3px">'+
                  '<div id="ach-bar-'+u.id+'" style="width:'+pct+'%;height:100%;background:'+(pct===100?'#22c55e':pct>50?'#f59e0b':'#1d4ed8')+';border-radius:2px"></div>'+
                '</div>'+
              '</div>'+
              '<span style="color:#64748b;font-size:18px">'+( isOpen?'â–²':'â–¼')+'</span>'+
            '</div>'+
          '</div>'+
          (isOpen?
            '<div style="margin-top:12px;border-top:1px solid rgba(255,255,255,0.07);padding-top:12px;display:flex;flex-direction:column;gap:6px">'+
              (relevantTopics.length===0?'<p style="color:#475569;font-size:13px">××™×Ÿ × ×•×©××™× ×¨×œ×•×•× ×˜×™×™× ×œ××§×¦×•×¢ ×–×”</p>':
                relevantTopics.map(function(t){
                  var checked=userAch[t.id]||false;
                  var rowId='ach-row-'+u.id+'-'+t.id;
                  return '<div id="'+rowId+'" style="display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.03);border-radius:8px;padding:10px 12px">'+
                    '<span id="ach-lbl-'+u.id+'-'+t.id+'" style="font-size:13px;color:'+(checked?'#22c55e':'#94a3b8')+'">'+(checked?'âœ“ ':'')+e(t.name)+'</span>'+
                    '<input type="checkbox" '+(checked?'checked':'')+
                      ' onchange="adminToggleAch('+u.id+',\''+t.id+'\',this)" '+
                      ' onclick="event.stopPropagation()" '+
                      ' style="width:20px;height:20px;cursor:pointer;accent-color:#22c55e;flex-shrink:0"/>'+
                  '</div>';
                }).join('')
              )+
            '</div>'
          :'')+
        '</div>';
      }).join('')+
    '</div>';
  }

  // â”€â”€ Non-admin: user fills their own achievements â”€â”€
  var userAch=S.achievements[S.me.id]||{};
  var myTopics=S.achieveTopics.filter(function(t){return !t.prof||t.prof===S.me.prof;});
  var done2=myTopics.filter(function(t){return userAch[t.id];}).length;
  var total2=myTopics.length;
  var pct2=total2>0?Math.round(done2/total2*100):0;

  return '<div>'+
    hdr('ğŸ† ×”×©×’×™× ×©×œ×™','')+
    // Progress bar
    '<div class="card" style="margin-bottom:16px">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'+
        '<span style="color:#94a3b8;font-size:13px">×”×ª×§×“××•×ª ×›×œ×œ×™×ª</span>'+
        '<span id="my-pct" style="font-weight:700;font-size:16px;color:'+(pct2===100?'#22c55e':pct2>50?'#f59e0b':'#60a5fa')+'">'+pct2+'%</span>'+
      '</div>'+
      '<div style="width:100%;height:8px;background:rgba(255,255,255,0.08);border-radius:4px">'+
        '<div id="my-prog-bar" style="width:'+pct2+'%;height:100%;background:linear-gradient(90deg,'+(pct2===100?'#059669,#22c55e':pct2>50?'#d97706,#f59e0b':'#1d4ed8,#60a5fa')+');border-radius:4px;transition:width 0.3s"></div>'+
      '</div>'+
      '<p id="my-prog-txt" style="color:#475569;font-size:12px;margin-top:6px">'+done2+' ××ª×•×š '+total2+' × ×•×©××™× ×”×•×©×œ××•</p>'+
    '</div>'+
    (S.me.prof?
      '<div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;background:rgba(8,145,178,0.08);border:1px solid rgba(8,145,178,0.2);border-radius:10px;padding:10px 14px">'+
        '<span>âš™ï¸</span><span style="color:#38bdf8;font-size:14px;font-weight:600">××§×¦×•×¢: '+e(S.me.prof)+'</span>'+
      '</div>'
    :'')+
    '<p style="color:#475569;font-size:12px;margin-bottom:12px">×¡××Ÿ âœ“ ×¢×œ ×›×œ × ×•×©× ×©×”×©×œ××ª. ×”×× ×”×œ ×¨×•××” ××ª ×”×”×ª×§×“××•×ª ×©×œ×š.</p>'+
    (myTopics.length===0?emp('××™×Ÿ × ×•×©××™× ××•×’×“×¨×™× ×¢×“×™×™×Ÿ'):
      myTopics.map(function(t){
        var checked=userAch[t.id]||false;
        var uid=S.me.id;
        return '<div id="my-ach-row-'+t.id+'" class="card" style="margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer" onclick="selfToggleAch(\''+t.id+'\')">'+
          '<span id="my-ach-lbl-'+t.id+'" style="font-size:14px;color:'+(checked?'#22c55e':'#94a3b8')+';font-weight:'+(checked?600:400)+'">'+(checked?'âœ… ':'â¬œ ')+e(t.name)+'</span>'+
          '<span id="my-ach-tag-'+t.id+'" style="background:'+(checked?'rgba(34,197,94,0.15)':'rgba(100,116,139,0.1)')+';color:'+(checked?'#22c55e':'#475569')+';font-size:11px;padding:3px 12px;border-radius:10px;font-weight:600;flex-shrink:0">'+(checked?'×”×•×©×œ×':'×œ×—×¥ ×œ×¡×™××•×Ÿ')+'</span>'+
        '</div>';
      }).join('')
    )+
  '</div>';
}

function rTsalam(){
  var isAdmin=S.me.role==='admin';
  var cats={};
  S.tsamItems.forEach(function(it){if(!cats[it.cat])cats[it.cat]=[];cats[it.cat].push(it);});
  var catNames=Object.keys(cats);
  var today=new Date().toISOString().slice(0,10);

  if(isAdmin){
    // Admin: manage items + collapsible report cards
    var expanded=S._tsamExpand||null;
    return '<div>'+
      hdr('ğŸ“¸ ×“×•×— ×¦×œ× â€” × ×™×”×•×œ','<button class="btn borange" onclick="openM(\'tsamitem\')" style="font-size:13px;padding:8px 14px">+ ×”×•×¡×£ ×¤×¨×™×˜</button>')+
      '<div style="margin-bottom:24px">'+
        '<h3 style="color:#94a3b8;font-size:14px;margin-bottom:12px">×¤×¨×™×˜×™× ×‘××¢×¨×›×ª</h3>'+
        catNames.map(function(cat){
          return '<div style="margin-bottom:14px">'+
            '<p style="color:#64748b;font-size:12px;font-weight:600;margin-bottom:6px;letter-spacing:1px">'+e(cat)+'</p>'+
            '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:6px">'+
              cats[cat].map(function(it){
                return '<div class="card" style="margin-bottom:0;display:flex;justify-content:space-between;align-items:center;padding:10px 12px">'+
                  '<span style="font-size:13px">'+e(it.name)+'</span>'+
                  '<div style="display:flex;gap:4px">'+
                    '<button onclick="editTsamItem('+it.id+')" style="background:rgba(29,78,216,0.1);border:1px solid rgba(29,78,216,0.2);border-radius:6px;padding:3px 6px;cursor:pointer;color:#60a5fa;font-size:11px">âœï¸</button>'+
                    '<button onclick="delTsamItem('+it.id+')" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:6px;padding:3px 6px;cursor:pointer;color:#ef4444;font-size:11px">ğŸ—‘</button>'+
                  '</div>'+
                '</div>';
              }).join('')+
            '</div>'+
          '</div>';
        }).join('')+
      '</div>'+
      '<h3 style="color:#94a3b8;font-size:14px;margin-bottom:12px">×“×•×—×•×ª ×©× ×©×œ×—×•</h3>'+
      (S.tsamReports.length===0?emp('××™×Ÿ ×“×•×—×•×ª ×¢×“×™×™×Ÿ'):
        S.tsamReports.slice().reverse().map(function(r){
          var u=S.users.find(function(x){return x.id===r.uid;});
          var isOpen=expanded===r.id;
          var rc2=u?RC[u.role]:'#64748b';
          return '<div class="card" style="margin-bottom:8px;cursor:pointer" onclick="toggleTsamExpand('+r.id+')">'+
            '<div style="display:flex;justify-content:space-between;align-items:center">'+
              '<div style="display:flex;align-items:center;gap:10px">'+
                '<div style="width:34px;height:34px;border-radius:50%;background:'+rc2+'22;border:2px solid '+rc2+';display:flex;align-items:center;justify-content:center;font-weight:700;color:'+rc2+';font-size:14px">'+(u?u.name[0]:'?')+'</div>'+
                '<div>'+
                  '<p style="font-weight:600;font-size:14px">'+(u?e(u.name):'×œ× ×™×“×•×¢')+'</p>'+
                  '<p style="color:#64748b;font-size:12px">'+(u?RL[u.role]+' | ':'')+e(r.date||'')+'</p>'+
                '</div>'+
              '</div>'+
              '<span style="color:#64748b;font-size:18px;transition:transform 0.2s;display:inline-block;transform:'+(isOpen?'rotate(180deg)':'rotate(0deg)')+'">â€º</span>'+
            '</div>'+
            (isOpen?
              '<div style="margin-top:12px;border-top:1px solid rgba(255,255,255,0.07);padding-top:12px;display:flex;flex-direction:column;gap:5px">'+
                S.tsamItems.map(function(it){
                  var v=r.vals[it.id];
                  if(v===undefined||v===null||v==='')return '';
                  return '<div style="display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.04);border-radius:6px;padding:6px 10px">'+
                    '<span style="color:#94a3b8;font-size:13px">'+e(it.name)+'</span>'+
                    '<span style="color:#38bdf8;font-weight:600;font-size:13px;font-family:monospace;letter-spacing:1px" dir="ltr">'+e(String(v))+'</span>'+
                  '</div>';
                }).filter(Boolean).join('')+
              '</div>'
            :'')+
          '</div>';
        }).join('')
      )+
    '</div>';
  }

  // Non-admin: one report per day + history
  var myReports=S.tsamReports.filter(function(r){return r.uid===S.me.id;}).slice().sort(function(a,b){return b.date.localeCompare(a.date);});
  var todayReport=myReports.find(function(r){return r.date===today;});
  var vals=todayReport?todayReport.vals:{};
  var histExpand=S._tsamHistExpand||null;

  return '<div>'+
    hdr('ğŸ“¸ ×“×•×— ×¦×œ×',
      '<button class="btn" style="background:linear-gradient(135deg,#0891b2,#0e7490);font-size:13px;padding:8px 14px" onclick="collectAndOpenTsalam()">'+
        (todayReport?'ğŸ’¾ ×¢×“×›×Ÿ ×“×•×—':'ğŸ“¤ ×©×œ×— ×“×•×—')+
      '</button>'
    )+
    // today status banner
    (todayReport?
      '<div style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:10px;padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:8px">'+
        '<span style="color:#22c55e;font-size:16px">âœ“</span>'+
        '<span style="color:#22c55e;font-size:13px">×“×•×— × ×©×œ×— ×”×™×•× ('+e(today)+'). × ×™×ª×Ÿ ×œ×¢×¨×•×š ×•×œ×¢×“×›×Ÿ.</span>'+
      '</div>'
    :
      '<div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:10px;padding:10px 14px;margin-bottom:14px">'+
        '<p style="color:#f59e0b;font-size:13px">×˜×¨× × ×©×œ×— ×“×•×— ×œ×”×™×•× ('+e(today)+')</p>'+
      '</div>'
    )+
    '<p style="color:#64748b;font-size:13px;margin-bottom:16px">×”×–×Ÿ ××¡×¤×¨ × ×›"×œ ×œ×›×œ ×¤×¨×™×˜ (2â€“20 ×¡×¤×¨×•×ª). ×©×“×•×ª ×¨×™×§×™× ×œ× ×™×©×œ×—×•.</p>'+
    catNames.map(function(cat){
      return '<div style="margin-bottom:20px">'+
        '<p style="color:#7c3aed;font-size:13px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px">'+
          '<span style="width:8px;height:8px;border-radius:50%;background:#7c3aed;display:inline-block"></span>'+
          e(cat)+
        '</p>'+
        '<div style="display:flex;flex-direction:column;gap:8px">'+
          cats[cat].map(function(it){
            var saved=vals[it.id]!==undefined?e(String(vals[it.id])):'';
            var inputHtml;
            if(it.type==='count'){
              var max=it.maxCount||6;
              inputHtml='<select id="tsam_'+it.id+'" style="padding:7px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.07);color:white;font-size:14px;font-weight:600;min-width:70px">'+
                Array.from({length:max+1},function(_,i){return '<option value="'+(i===0?'':i)+'"'+(saved===String(i)&&i>0?' selected':'')+'>'+(i===0?'×œ×œ×':i)+'</option>';}).join('')+
              '</select>';
            }else{
              inputHtml='<input type="text" inputmode="numeric" id="tsam_'+it.id+'" value="'+saved+'" '+
                'placeholder="××¡×¤×¨ × ×›&quot;×œ (2â€“20 ×¡×¤×¨×•×ª)" '+
                'oninput="validateTsamField(\''+it.id+'\')" '+
                'style="width:100%;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05);color:white;font-size:13px;font-family:monospace;letter-spacing:1px" dir="ltr"/>';
            }
            return '<div class="card" style="margin-bottom:0;padding:10px 14px">'+
              '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:'+(it.type==='count'?'0':'6px')+'">'+
                '<span style="font-size:14px;color:#e2e8f0;font-weight:600">'+e(it.name)+'</span>'+
                (it.type==='count'?inputHtml:'<span id="tsam_err_'+it.id+'" style="color:#ef4444;font-size:11px"></span>')+
              '</div>'+
              (it.type!=='count'?inputHtml:'')+
            '</div>';
          }).join('')+
        '</div>'+
      '</div>';
    }).join('')+
    // history section
    (myReports.length>0?
      '<div style="margin-top:24px;border-top:1px solid rgba(255,255,255,0.06);padding-top:18px">'+
        '<h3 style="color:#94a3b8;font-size:14px;margin-bottom:12px">ğŸ“‚ ×“×•×—×•×ª ×§×•×“××™×</h3>'+
        myReports.map(function(r){
          var isOpen=histExpand===r.id;
          var isToday=r.date===today;
          return '<div class="card" style="margin-bottom:8px;cursor:pointer" onclick="toggleTsamHist('+r.id+')">'+
            '<div style="display:flex;justify-content:space-between;align-items:center">'+
              '<div style="display:flex;align-items:center;gap:8px">'+
                '<span style="font-size:18px">'+(isToday?'ğŸ“…':'ğŸ“„')+'</span>'+
                '<span style="font-weight:600;font-size:14px">'+e(r.date)+(isToday?' <span style="background:rgba(34,197,94,0.15);color:#22c55e;font-size:11px;padding:2px 8px;border-radius:10px;font-weight:600">×”×™×•×</span>':'')+'</span>'+
              '</div>'+
              '<span style="color:#64748b;font-size:18px;display:inline-block;transform:'+(isOpen?'rotate(180deg)':'rotate(0deg)')+'">â€º</span>'+
            '</div>'+
            (isOpen?
              '<div style="margin-top:10px;border-top:1px solid rgba(255,255,255,0.06);padding-top:10px;display:flex;flex-direction:column;gap:4px">'+
                S.tsamItems.map(function(it){
                  var v=r.vals[it.id];
                  if(v===undefined||v===null||v==='')return '';
                  return '<div style="display:flex;justify-content:space-between;background:rgba(255,255,255,0.04);border-radius:6px;padding:5px 10px">'+
                    '<span style="color:#94a3b8;font-size:12px">'+e(it.name)+'</span>'+
                    '<span style="color:#38bdf8;font-size:12px;font-family:monospace;font-weight:600" dir="ltr">'+e(String(v))+'</span>'+
                  '</div>';
                }).filter(Boolean).join('')+
              '</div>'
            :'')+
          '</div>';
        }).join('')+
      '</div>'
    :'')+
  '</div>';
}

function hdr(t,b){return '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h2 style="font-size:18px">'+t+'</h2>'+(b||'')+'</div>';}

// ACTIONS
function setLTab(t){S.ltab=t;S.lerr='';S.fp=0;S.fsc=false;S.fdn=false;render();}
function doLogin(){
  S.lu=document.getElementById('lu')?document.getElementById('lu').value:S.lu;
  S.lp=document.getElementById('lp')?document.getElementById('lp').value:S.lp;
  var u=S.users.find(function(x){return x.un===S.lu&&x.pw===S.lp});
  if(u){S.me=u;S.page='app';S.tab=getTabs()[0].id;render();}
  else{S.lerr='×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×';render();}
}
function startFace(){
  if(S.fsc||S.fdn)return;
  S.lu=document.getElementById('lu')?document.getElementById('lu').value:S.lu;
  S.fsc=true;S.fp=0;
  var iv=setInterval(function(){
    S.fp+=7;if(S.fp>100)S.fp=100;
    render();
    if(S.fp>=100){clearInterval(iv);S.fsc=false;S.fdn=true;render();
      setTimeout(function(){
        var u=S.users.find(function(x){return x.un===S.lu});
        if(u){S.me=u;S.page='app';S.tab=getTabs()[0].id;render();}
        else{S.lerr='×”×–×Ÿ ×©× ××©×ª××© ×ª×§×™×Ÿ';S.fdn=false;render();}
      },500);
    }
  },100);
}
function logout(){S.me=null;S.page='login';S.lu='';S.lp='';S.lerr='';S.fdn=false;S.fsc=false;S.fp=0;render();}
function setTab(t){S.tab=t;S.modal='';render();}
function openM(m){S.modal=m;render();}
function closeM(){S.modal='';S._modalOverride=null;S._tankTypeOverride=null;S._tankNumOverride=null;render();}
function apR(id){S.reqs=S.reqs.map(function(r){return r.id===id?Object.assign({},r,{status:'approved'}):r});if(window.fbSaveData)fbSaveData();render();}
function rejR(id){S.reqs=S.reqs.map(function(r){return r.id===id?Object.assign({},r,{status:'rejected'}):r});if(window.fbSaveData)fbSaveData();render();}
function apS(id){S.special=S.special.map(function(r){return r.id===id?Object.assign({},r,{status:'approved'}):r});if(window.fbSaveData)fbSaveData();render();}
function rejS(id){S.special=S.special.map(function(r){return r.id===id?Object.assign({},r,{status:'rejected'}):r});if(window.fbSaveData)fbSaveData();render();}
function editU(id){S.eid=id;S.modal='edituser';render();}
function delU(id){if(confirm('×œ××—×•×§ ××©×ª××©?')){S.users=S.users.filter(function(u){return u.id!==id});if(window.fbSaveConfig)fbSaveConfig();render();}}

function svDaily(){S.daily.push({id:Date.now(),uid:S.me.id,uname:S.me.name,content:gv('fc'),cat:gv('fcat')});if(window.fbSaveData)fbSaveData();closeM();}
function svReq(){S.reqs.push({id:Date.now(),uid:S.me.id,uname:S.me.name,reason:gv('fr'),date:gv('fd'),dateTo:gv('fdt'),st:gv('fst'),et:gv('fet'),notes:gv('fn'),status:'pending'});if(window.fbSaveData)fbSaveData();closeM();}
function openTank(){S._tankTypeOverride=null;S._tankNumOverride=null;openM('tank');}
function onTankTypeChange(val){
  S._tankTypeOverride=val;
  S._tankNumOverride=document.getElementById('ftk')?document.getElementById('ftk').value:'';
  // re-render modal to show/hide shatzal fields
  S.modal='tank';render();
}
function svTank(){
  var type=gv('fty');
  if(!type)return alert('×‘×—×¨ ×¡×•×’ ×“×™×•×•×—');
  var shatzal={};
  if(type==='×©×¦×œ'){
    S.shatzalTypes.forEach(function(st){
      var v=parseInt(document.getElementById('sh_'+st.id)?document.getElementById('sh_'+st.id).value:0)||0;
      if(v>0)shatzal[st.id]=v;
    });
  }
  S.tanks.push({id:Date.now(),uid:S.me.id,uname:S.me.name,tank:gv('ftk'),type:type,desc:gv('fds'),shatzal:shatzal});
  S._tankTypeOverride=null;S._tankNumOverride=null;
  if(window.fbSaveData)fbSaveData();
  closeM();
}
function svShatzal(mode){
  var name=gv('fshname').trim();
  if(!name)return alert('×”×–×Ÿ ×©×');
  if(mode==='editshatzal'){
    S.shatzalTypes=S.shatzalTypes.map(function(st){return st.id===S._shatzalEditId?{id:st.id,name:name}:st;});
  }else{
    S.shatzalTypes.push({id:'sh'+Date.now(),name:name});
  }
  if(window.fbSaveConfig)fbSaveConfig();
  closeM();
}
function editShatzal(id){S._shatzalEditId=id;S.modal='editshatzal';render();}
function delShatzal(id){if(confirm('×œ××—×•×§?')){S.shatzalTypes=S.shatzalTypes.filter(function(x){return x.id!==id;});if(window.fbSaveConfig)fbSaveConfig();render();}}
function svSpecial(){S.special.push({id:Date.now(),uid:S.me.id,uname:S.me.name,subj:gv('fsb'),content:gv('fc'),prio:gv('fpr'),status:'pending'});if(window.fbSaveData)fbSaveData();closeM();}
function svSched(){
  var uid=parseInt(gv('fuid'));if(!uid)return alert('×‘×—×¨ ××©×ª××©');
  S.scheds=S.scheds.filter(function(s){return !(s.uid===uid&&s.date===gv('fd'))});
  S.scheds.push({id:Date.now(),uid:uid,reason:gv('fr'),date:gv('fd'),st:gv('fst'),et:gv('fet'),type:gv('fty')});
  if(window.fbSaveData)fbSaveData();
  closeM();
}
function reRenderModal(){
  var role=gv('frl');
  var override={name:gv('fn'),un:gv('fun'),pw:gv('fpw'),role:role,team:gv('ftm'),prof:gv('fprof')||null};
  if(role==='mm'){
    override.cids=[parseInt(gv('fci0'))||null,parseInt(gv('fci1'))||null];
  } else if(role==='commander'||role==='maf'||role==='smaf'){
    override.solids=[parseInt(gv('fsol0'))||null,parseInt(gv('fsol1'))||null,parseInt(gv('fsol2'))||null,parseInt(gv('fsol3'))||null];
  } else if(role==='soldier'){
    override.cid=parseInt(gv('fci'))||null;
    override.mid=parseInt(gv('fmi'))||null;
  }
  S._modalOverride=override;
  render();
}
function svUser(mode){
  var role=gv('frl')||'soldier';
  var team=gv('ftm')||null;
  var updates={name:gv('fn'),un:gv('fun'),pw:gv('fpw'),role:role,team:team,prof:gv('fprof')||null,cid:null,mid:null,cids:null,solids:null};
  if(role==='mm'){
    updates.cids=[parseInt(gv('fci0'))||null,parseInt(gv('fci1'))||null].filter(Boolean);
  } else if(role==='commander'||role==='maf'||role==='smaf'){
    updates.solids=[parseInt(gv('fsol0'))||null,parseInt(gv('fsol1'))||null,parseInt(gv('fsol2'))||null,parseInt(gv('fsol3'))||null].filter(Boolean);
  } else if(role==='soldier'){
    updates.cid=parseInt(gv('fci'))||null;
    updates.mid=parseInt(gv('fmi'))||null;
  }
  if(mode==='edituser'){
    S.users=S.users.map(function(u){return u.id===S.eid?Object.assign({},u,updates):u;});
  }else{
    S.users.push(Object.assign({id:Date.now()},updates));
  }
  if(window.fbSaveConfig)fbSaveConfig();
  closeM();
}

// â”€â”€ TSALAM ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function validateTsamField(id){
  var el=document.getElementById('tsam_'+id);
  var errEl=document.getElementById('tsam_err_'+id);
  if(!el||!errEl)return;
  var val=el.value.replace(/\D/g,'');
  if(val.length>20)val=val.slice(0,20);
  el.value=val;
  if(val.length===0){
    errEl.textContent='';
    el.style.borderColor='rgba(255,255,255,0.12)';
  }else if(val.length<2){
    errEl.textContent='××™× ×™××•× 2 ×¡×¤×¨×•×ª';
    errEl.style.color='#ef4444';
    el.style.borderColor='rgba(239,68,68,0.6)';
  }else{
    errEl.textContent='âœ“';
    errEl.style.color='#22c55e';
    el.style.borderColor='rgba(34,197,94,0.5)';
  }
}
function collectAndOpenTsalam(){
  var errors=[];
  S.tsamItems.forEach(function(it){
    if(it.type==='count')return; // dropdown, no validation needed
    var el=document.getElementById('tsam_'+it.id);
    if(el&&el.value.length>0&&el.value.length<2){
      errors.push(e(it.name)+': ××™× ×™××•× 2 ×¡×¤×¨×•×ª');
    }
  });
  if(errors.length>0){alert('×©×’×™××•×ª:\n'+errors.join('\n'));return;}
  var vals={};
  S.tsamItems.forEach(function(it){
    var el=document.getElementById('tsam_'+it.id);
    if(el&&el.value.trim()!=='')vals[it.id]=el.value.trim();
  });
  S._pendingTsamVals=vals;
  openM('tsalam');
}
function svTsalam(){
  var date=gv('ftd')||new Date().toISOString().slice(0,10);
  var existing=S.tsamReports.findIndex(function(r){return r.uid===S.me.id&&r.date===date;});
  var report={id:existing>=0?S.tsamReports[existing].id:Date.now(),uid:S.me.id,uname:S.me.name,date:date,vals:S._pendingTsamVals||{}};
  if(existing>=0){S.tsamReports[existing]=report;}
  else{S.tsamReports.push(report);}
  S._pendingTsamVals=null;
  if(window.fbSaveData)fbSaveData();
  closeM();
}
function toggleTsamExpand(id){S._tsamExpand=S._tsamExpand===id?null:id;render();}
function toggleTsamHist(id){S._tsamHistExpand=S._tsamHistExpand===id?null:id;render();}
function svTsamItem(mode){
  var name=gv('ftiname').trim(),cat=gv('fticat').trim();
  if(!name||!cat)return alert('×™×© ×œ××œ× ×©× ×•×§×˜×’×•×¨×™×”');
  if(mode==='edittsamitem'){
    S.tsamItems=S.tsamItems.map(function(it){return it.id===S._tsamEditId?Object.assign({},it,{name:name,cat:cat}):it;});
  }else{
    S.tsamItems.push({id:Date.now(),cat:cat,name:name});
  }
  if(window.fbSaveConfig)fbSaveConfig();
  closeM();
}
function editTsamItem(id){S._tsamEditId=id;S.modal='edittsamitem';render();}
function delTsamItem(id){if(confirm('×œ××—×•×§ ×¤×¨×™×˜?')){S.tsamItems=S.tsamItems.filter(function(x){return x.id!==id;});if(window.fbSaveConfig)fbSaveConfig();render();}}

// â”€â”€ ACHIEVEMENT ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selfToggleAch(tid){
  var uid=S.me.id;
  if(!S.achievements[uid])S.achievements[uid]={};
  var newVal=!S.achievements[uid][tid];
  S.achievements[uid][tid]=newVal;
  if(window.fbSaveData)fbSaveData();
  var lbl=document.getElementById('my-ach-lbl-'+tid);
  var tag=document.getElementById('my-ach-tag-'+tid);
  var topic=S.achieveTopics.find(function(t){return t.id===tid;});
  if(lbl){lbl.textContent=(newVal?'âœ… ':'â¬œ ')+(topic?topic.name:'');lbl.style.color=newVal?'#22c55e':'#94a3b8';lbl.style.fontWeight=newVal?600:400;}
  if(tag){tag.textContent=newVal?'×”×•×©×œ×':'×œ×—×¥ ×œ×¡×™××•×Ÿ';tag.style.background=newVal?'rgba(34,197,94,0.15)':'rgba(100,116,139,0.1)';tag.style.color=newVal?'#22c55e':'#475569';}
  var myTopics=S.achieveTopics.filter(function(t){return !t.prof||t.prof===S.me.prof;});
  var done=myTopics.filter(function(t){return S.achievements[uid][t.id];}).length;
  var total=myTopics.length;
  var pct=total>0?Math.round(done/total*100):0;
  var pctEl=document.getElementById('my-pct');
  var barEl=document.getElementById('my-prog-bar');
  var txtEl=document.getElementById('my-prog-txt');
  if(pctEl){pctEl.textContent=pct+'%';pctEl.style.color=pct===100?'#22c55e':pct>50?'#f59e0b':'#60a5fa';}
  if(barEl){barEl.style.width=pct+'%';}
  if(txtEl){txtEl.textContent=done+' ××ª×•×š '+total+' × ×•×©××™× ×”×•×©×œ××•';}
}

function adminToggleAch(uid,tid,cb){
  if(!S.achievements[uid])S.achievements[uid]={};
  S.achievements[uid][tid]=cb.checked;
  if(window.fbSaveData)fbSaveData();
  var lbl=document.getElementById('ach-lbl-'+uid+'-'+tid);
  var topic=S.achieveTopics.find(function(t){return t.id===tid;});
  if(lbl){lbl.textContent=(cb.checked?'âœ“ ':'')+( topic?topic.name:'');lbl.style.color=cb.checked?'#22c55e':'#94a3b8';}
  var relevantTopics=S.achieveTopics.filter(function(t){var u2=S.users.find(function(x){return x.id===uid;});return !t.prof||(u2&&t.prof===u2.prof);});
  var done=relevantTopics.filter(function(t){return S.achievements[uid]&&S.achievements[uid][t.id];}).length;
  var total=relevantTopics.length;
  var pct=total>0?Math.round(done/total*100):0;
  var progEl=document.getElementById('ach-prog-'+uid);
  var barEl=document.getElementById('ach-bar-'+uid);
  if(progEl){progEl.textContent=done+'/'+total;progEl.style.color=pct===100?'#22c55e':pct>50?'#f59e0b':'#64748b';}
  if(barEl){barEl.style.width=pct+'%';barEl.style.background=pct===100?'#22c55e':pct>50?'#f59e0b':'#1d4ed8';}
}

function toggleAchExpand(uid){S._achExpand=S._achExpand===uid?null:uid;render();}
function svTopic(){
  var name=gv('ftopicname').trim();
  if(!name)return alert('×”×–×Ÿ ×©× × ×•×©×');
  var prof=gv('ftopicprof')||null;
  S.achieveTopics.push({id:'t'+Date.now(),name:name,prof:prof});
  if(window.fbSaveConfig)fbSaveConfig();
  closeM();
}
function delTopic(id){
  if(confirm('×œ××—×•×§ × ×•×©×?')){
    S.achieveTopics=S.achieveTopics.filter(function(t){return t.id!==id;});
    Object.keys(S.achievements).forEach(function(uid){if(S.achievements[uid])delete S.achievements[uid][id];});
    if(window.fbSaveConfig)fbSaveConfig();
    if(window.fbSaveData)fbSaveData();
    render();
  }
}

// render() is called by Firebase after data loads
</script>
</body>
</html>
